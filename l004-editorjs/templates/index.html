<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Streaming Chat & Simple Report</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      display: flex;
      height: 100vh;
    }

    #left,
    #right {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      box-sizing: border-box;
    }

    #left {
      border-right: 2px solid #ddd;
    }

    .section {
      margin-bottom: 20px;
    }

    .message.assistant {
      color: blue;
    }

    .message.final {
      color: green;
    }

    .thought {
      font-style: italic;
      color: #555;
    }

    #report-holder {
      background: #fafafa;
      border: 1px solid #ccc;
      padding: 10px;
      min-height: 200px;
    }
  </style>
</head>

<body>

  <div id="left">
    <div class="section" id="chat">
      <h2>Chat</h2>
      <div id="chat-messages"></div>
      <form id="input-form"><input id="user-input" autocomplete="off" placeholder="Type your requestâ€¦"
          style="width:100%;" /></form>
    </div>
  </div>

  <div id="right">
    <div class="section">
      <h2>ðŸ§  Thoughts</h2>
      <div id="thoughts"></div>
    </div>
    <div class="section">
      <h2>ðŸ“„ Report</h2>
      <div id="report-holder"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@2.29.1"></script>

  <script>
    window.addEventListener('load', () => {
      const editor = new EditorJS({
        holder: 'report-holder',
        readOnly: true,
        data: { blocks: [] }
      });

      editor.isReady
        .then(() => console.log('âœ… Editor.js is ready!'))
        .catch(err => console.error('âŒ Editor.js initialization failed:', err));

      const chatDiv = document.getElementById('chat-messages');
      const thoughtsDiv = document.getElementById('thoughts');
      const reportHolder = document.getElementById('report-holder');
      const inputForm = document.getElementById('input-form');
      const inputField = document.getElementById('user-input');

      inputForm.addEventListener('submit', async e => {
        e.preventDefault();
        const text = inputField.value.trim();
        if (!text) return;
        appendChat('You', text);
        inputField.value = '';
        thoughtsDiv.innerHTML = '';
        try {
          await editor.isReady;
          editor.blocks.clear();
        } catch (error) {
          console.error("Failed to clear Editor.js, but proceeding with chat:", error);
        }
        streamChat(text);
      });

      async function streamChat(text) {
        const resp = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'text/event-stream' },
          body: JSON.stringify({ input: text, user_id: 0 })
        });
        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          const parts = buffer.split('\n\n');
          buffer = parts.pop();
          for (const chunk of parts) {
            const lines = chunk.split('\n');
            let evt = '', data = '';
            for (const l of lines) {
              if (l.startsWith('event:')) evt = l.slice(6).trim();
              else if (l.startsWith('data:')) data += l.slice(5); // Don't add extra newlines
            }
            handleEvent(evt, data);
          }
        }
      }

      function handleEvent(event, data) {
        if (event === 'initial') {
          appendChat('assistant', data);
        } else if (event === 'thought') {
          appendThought(data);
        } else if (event === 'report') {
          // The data for a 'report' event is now a JSON string
          try {
            const reportData = JSON.parse(data);
            appendReport(reportData);
          } catch (e) {
            console.error("Failed to parse report JSON:", e, data);
          }
        } else if (event === 'final') {
          appendChat('assistant', data, 'final');
        }
      }

      function appendChat(who, text, css = '') {
        const d = document.createElement('div');
        d.className = 'message ' + css;
        d.textContent = `${who}: ${text}`;
        chatDiv.appendChild(d);
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }

      function appendThought(text) {
        const d = document.createElement('div');
        d.className = 'thought';
        d.textContent = text;
        thoughtsDiv.appendChild(d);
        thoughtsDiv.scrollTop = thoughtsDiv.scrollHeight;
      }

      // This function now receives a full Editor.js data object
      async function appendReport(reportData) {
        if (reportData && reportData.blocks) {
          await editor.isReady;
          // Use the editor's render() method to display the full report
          await editor.render(reportData);
          reportHolder.scrollTop = reportHolder.scrollHeight;
        }
      }
    });
  </script>
</body>

</html>